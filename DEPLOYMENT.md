# デプロイ手順書 (Deployment Guide)

Handover Player を本番環境 (Vercel + Supabase) にデプロイするための手順です。

## 1. 前提条件

*   GitHub アカウント
*   Vercel アカウント
*   Supabase アカウント

---

## 2. Supabase のセットアップ

データベースとバックエンドの設定を行います。

1.  [Supabase](https://supabase.com/) にログインし、「**New Project**」を作成します。
2.  プロジェクトが作成されたら、左サイドバーの「**SQL Editor**」を開きます。
3.  「**New query**」をクリックし、以下のSQLを貼り付けて「**Run**」を実行します。

```sql
-- 1. Projects テーブル (プロジェクト管理)
create table if not exists projects (
  id uuid default gen_random_uuid() primary key,
  title text default 'Untitled Project',
  source_url text not null,
  created_at timestamptz default now(),
  expires_at timestamptz default (now() + interval '7 days'),
  passcode_hash text,
  status text default 'active' check (status in ('active', 'expired', 'archived')),
  features jsonb default '{"passcode": false, "export_count": 0}'::jsonb
);

-- RLS (Row Level Security) の有効化
alter table projects enable row level security;

-- ポリシー設定: 誰でも作成・閲覧可能 (Soft Launchモード)
create policy "Public projects access" on projects for select using (true);
create policy "Public projects insert" on projects for insert with check (true);

-- 2. Comments テーブル (コメント管理)
create table if not exists comments (
  id bigint generated by default as identity primary key,
  project_uuid uuid not null references projects(id) on delete cascade,
  user_name text default 'Anonymous',
  text text,
  ptime float not null, -- 再生位置 (秒)
  created_at timestamptz default now()
);

-- RLS設定 for Comments
alter table comments enable row level security;
create policy "Public comments access" on comments for select using (true);
create policy "Public comments insert" on comments for insert with check (true);

-- 3. Realtime設定 (リアルタイム更新のため)
-- "Database" -> "Replication" から "supabase_realtime" の Source に "comments" テーブルが含まれていることを確認してください。
-- SQLで明示的に有効化する場合:
alter publication supabase_realtime add table comments;
```

4.  左サイドバーの「**Project Settings**」→「**API**」を開き、以下の2つをメモします。
    *   `Project URL`
    *   `anon` public key

---

## 3. Vercel へのデプロイ

フロントエンドをホスティングします。

1.  GitHub に最新のコードを Push します。
2.  [Vercel](https://vercel.com/) にログインし、「**Add New...**」→「**Project**」を選択します。
3.  GitHub リポジトリ (`handover-player`) をインポートします。
4.  **Configure Project** 画面で、「**Environment Variables**」を展開し、先ほどメモした Supabase のキーを入力します。

    *   `VITE_SUPABASE_URL`: (SupabaseのProject URL)
    *   `VITE_SUPABASE_ANON_KEY`: (Supabaseのanon key)

5.  「**Deploy**」をクリックします。
6.  ビルドが完了すると、自動的に URL (`https://handover-player-xxx.vercel.app`) が発行されます。

---

## 4. 動作確認

発行された Vercel の URL にアクセスし、以下の動作を確認してください。

1.  Dropbox の動画リンクを入力して「Start」を押す。
2.  「新しいプロジェクトを作成」ボタンを押し、プロジェクトURLが発行されること。
3.  動画が再生され、コメントが投稿・保存できること。

以上でデプロイは完了です！🚀
